<?php
// Play shortcode/page for HMQUIZ.
// Renders a polished play card shell around the existing [hmquiz] engine.
if (!defined('ABSPATH')) exit;

function hmqz_render_play_shortcode($atts = []) {
  // 1) Read from query string (primary for /quiz/ and /play/ links)
  $bank       = isset($_GET['bank'])       ? sanitize_text_field(wp_unslash($_GET['bank']))       : '';
  $topics     = isset($_GET['topics'])     ? sanitize_text_field(wp_unslash($_GET['topics']))     : '';
  $categories = isset($_GET['categories']) ? sanitize_text_field(wp_unslash($_GET['categories'])) : '';
  $per        = isset($_GET['per'])        ? intval($_GET['per'])                                 : 0;
  $level      = isset($_GET['level'])      ? intval($_GET['level'])                               : 1;
  $levels     = isset($_GET['levels'])     ? intval($_GET['levels'])                              : 1;
  $difficulty = isset($_GET['difficulty']) ? sanitize_text_field(wp_unslash($_GET['difficulty'])) : '';

  // 2) Fallbacks from shortcode attributes so do_shortcode() also works
  $atts = shortcode_atts([
    'bank'       => '',
    'topics'     => '',
    'categories' => '',
    'per'        => '',
    'level'      => '',
    'levels'     => '',
    'difficulty' => '',
    'title'      => '',
  ], $atts, 'hmqz_play');

  if (!$bank && !empty($atts['bank'])) {
    $bank = sanitize_text_field($atts['bank']);
  }
  if (!$topics && !empty($atts['topics'])) {
    $topics = sanitize_text_field($atts['topics']);
  }
  if (!$categories && !empty($atts['categories'])) {
    $categories = sanitize_text_field($atts['categories']);
  }
  if ($per <= 0 && !empty($atts['per'])) {
    $per = intval($atts['per']);
  }
  if ($level <= 0 && !empty($atts['level'])) {
    $level = intval($atts['level']);
  }
  if ($levels <= 0 && !empty($atts['levels'])) {
    $levels = intval($atts['levels']);
  }
  if (!$difficulty && !empty($atts['difficulty'])) {
    $difficulty = sanitize_text_field($atts['difficulty']);
  }

  if (!$bank) {
    return '<p>' . esc_html__('No quiz selected.', 'hmquiz') . '</p>';
  }

  if (!empty($atts['title'])) {
    $title = sanitize_text_field($atts['title']);
  } elseif ($categories) {
    $title = $categories;
  } elseif ($topics) {
    $title = $topics;
  } else {
    $title = $bank;
  }

  $topic_label = $topics ?: __('Playing HMQUIZ', 'hmquiz');

  $logo_url = defined('HMQZ_PLUGIN_URL') ? HMQZ_PLUGIN_URL . 'assets/img/hmquiz-logo.png' : '';
  $inner = do_shortcode('[hmquiz bank="' . esc_attr($bank) . '" title="' . esc_attr($title) . '"]');

  $chip_values = array_filter(array_map('trim', preg_split('/[,|]/', $topics . ',' . $categories)));
  $chip_values = array_slice(array_unique($chip_values), 0, 4);
  $lead_parts = [];
      // Figure out a nice display title for the hero header.
    // Priority: URL ?title= → shortcode atts 'title' → pretty bank name → "Quiz".
    $bank  = isset( $atts['bank'] ) ? sanitize_text_field( $atts['bank'] ) : '';
    $per   = isset( $atts['per'] ) ? intval( $atts['per'] ) : 10;
    $raw_title = isset( $atts['title'] ) ? sanitize_text_field( $atts['title'] ) : '';

    // Title from URL (e.g. &title=Affect%20vs%20Effect%20Quiz)
    $qs_title = '';
    if ( isset( $_GET['title'] ) ) {
        $qs_title = sanitize_text_field( wp_unslash( $_GET['title'] ) );
    }

    // Pretty version of the bank filename as a last resort
    $nice_bank = $bank;
    if ( $nice_bank ) {
        $nice_bank = preg_replace( '/\.json$/', '', $nice_bank );   // drop .json
        $nice_bank = str_replace( '_', ' ', $nice_bank );           // underscores → spaces
        $nice_bank = ucwords( $nice_bank );                         // capitalise words
    }

    $display_title = $qs_title ?: ( $raw_title ?: ( $nice_bank ?: __( 'Quiz', 'hmquiz' ) ) );

  if ($per > 0) {
    $lead_parts[] = sprintf(esc_html__('%d questions per level', 'hmquiz'), $per);
  }
  if ($levels > 1) {
    $lead_parts[] = sprintf(esc_html__('%d levels to clear', 'hmquiz'), $levels);
  }
  if ($difficulty) {
    $lead_parts[] = sprintf(esc_html__('Difficulty: %s', 'hmquiz'), $difficulty);
  }
  $hero_lead = $lead_parts ? implode(' • ', $lead_parts) : esc_html__('Answer questions, climb through the levels, and keep your streak alive.', 'hmquiz');

  ob_start();
  ?>
  <section class="hmqz-play-page">
    <div class="hmqz-play-card">
      <div class="hmqz-play-card-inner">
        <div class="hmqz-card-hero">
          <div class="hmqz-card-head">
            <div class="hmqz-card-title-wrap">
              <div class="hmqz-card-eyebrow"><?php esc_html_e('Live quiz', 'hmquiz'); ?></div>
              <h1 class="hmqz-card-title"><?php echo esc_html($title); ?></h1>
              <p class="hmqz-card-lead"><?php echo esc_html($hero_lead); ?></p>
              <?php if ($chip_values) : ?>
                <div class="hmqz-card-tags">
                  <?php foreach ($chip_values as $chip) : ?>
                    <span class="hmqz-chip"><?php echo esc_html($chip); ?></span>
                  <?php endforeach; ?>
                </div>
              <?php endif; ?>
            </div>
            <dl class="hmqz-card-meta-stack">
              <div class="hmqz-card-meta">
                <dt class="hmqz-card-meta-label"><?php esc_html_e('Level', 'hmquiz'); ?></dt>
                <dd class="hmqz-card-meta-value js-hmqz-level">
                  <?php printf(esc_html__('Level %1$d/%2$d', 'hmquiz'), max(1, $level), max(1, $levels)); ?>
                </dd>
              </div>
              <div class="hmqz-card-meta">
                <dt class="hmqz-card-meta-label"><?php esc_html_e('Time', 'hmquiz'); ?></dt>
                <dd class="hmqz-card-meta-value js-hmqz-timer">00:00</dd>
              </div>
              <div class="hmqz-card-meta">
                <dt class="hmqz-card-meta-label"><?php esc_html_e('Progress', 'hmquiz'); ?></dt>
                <dd class="hmqz-card-meta-value js-hmqz-qmeta">
                  <?php printf(esc_html__('Q %1$d/%2$d', 'hmquiz'), 1, max(1, $per)); ?>
                </dd>
              </div>
            </dl>
          </div>
          <div class="hmqz-card-progress">
            <div class="hmqz-card-progress-fill js-hmqz-progress"></div>
          </div>
        </div>

        <div class="hmqz-play-body">
          <div class="hmqz-runner-shell">
            <?php echo $inner; ?>
          </div>
        </div>
      </div>
    </div>
  </section>
  <?php
  return ob_get_clean();
}

add_shortcode('hmqz_play', 'hmqz_render_play_shortcode');
