<?php
// Play shortcode/page for HMQUIZ.
// Renders a polished play card shell around the existing [hmquiz] engine.
if (!defined('ABSPATH')) exit;

function hmqz_render_play_shortcode($atts = []) {
  // 1) Read from query string (primary for /quiz/ and /play/ links)
  $bank       = isset($_GET['bank'])       ? sanitize_text_field(wp_unslash($_GET['bank']))       : '';
  $topics     = isset($_GET['topics'])     ? sanitize_text_field(wp_unslash($_GET['topics']))     : '';
  $categories = isset($_GET['categories']) ? sanitize_text_field(wp_unslash($_GET['categories'])) : '';
  $per        = isset($_GET['per'])        ? intval($_GET['per'])                                 : 0;
  $level      = isset($_GET['level'])      ? intval($_GET['level'])                               : 1;
  $levels     = isset($_GET['levels'])     ? intval($_GET['levels'])                              : 1;
  $difficulty = isset($_GET['difficulty']) ? sanitize_text_field(wp_unslash($_GET['difficulty'])) : '';

  // 2) Fallbacks from shortcode attributes so do_shortcode() also works
  $atts = shortcode_atts([
    'bank'       => '',
    'topics'     => '',
    'categories' => '',
    'per'        => '',
    'level'      => '',
    'levels'     => '',
    'difficulty' => '',
    'title'      => '',
  ], $atts, 'hmqz_play');

  if (!$bank && !empty($atts['bank'])) {
    $bank = sanitize_text_field($atts['bank']);
  }
  if (!$topics && !empty($atts['topics'])) {
    $topics = sanitize_text_field($atts['topics']);
  }
  if (!$categories && !empty($atts['categories'])) {
    $categories = sanitize_text_field($atts['categories']);
  }
  if ($per <= 0 && !empty($atts['per'])) {
    $per = intval($atts['per']);
  }
  if ($levels <= 0 && !empty($atts['levels'])) {
    $levels = intval($atts['levels']);
  }
  if (!$difficulty && !empty($atts['difficulty'])) {
    $difficulty = sanitize_text_field($atts['difficulty']);
  }

  if (!$bank) {
    return '<p>' . esc_html__('No quiz selected.', 'hmquiz') . '</p>';
  }

  // Base title used for hmquiz engine + fallback
  if (!empty($atts['title'])) {
    $title = sanitize_text_field($atts['title']);
  } elseif ($categories) {
    $title = $categories;
  } elseif ($topics) {
    $title = $topics;
  } else {
    $title = $bank;
  }

  // Friendly hero display title for the play shell.
  // Priority: URL ?title= → derived $title → pretty bank name → "Quiz".
  $qs_title = '';
  if ( isset( $_GET['title'] ) ) {
    $qs_title = sanitize_text_field( wp_unslash( $_GET['title'] ) );
  }

  // Pretty version of the bank filename as a last resort.
  $nice_bank = $bank;
  if ( $nice_bank ) {
    $nice_bank = preg_replace( '/\.json$/', '', $nice_bank ); // drop .json
    $nice_bank = str_replace( '_', ' ', $nice_bank );          // underscores → spaces
    $nice_bank = ucwords( $nice_bank );                        // capitalise words
  }

  $display_title = $qs_title ?: ( $title ?: ( $nice_bank ?: __( 'Quiz', 'hmquiz' ) ) );

  $topic_label = $topics ?: __('Playing HMQUIZ', 'hmquiz');

  $logo_url = defined('HMQZ_PLUGIN_URL') ? HMQZ_PLUGIN_URL . 'assets/img/hmquiz-logo.png' : '';
  $inner = do_shortcode('[hmquiz bank="' . esc_attr($bank) . '" title="' . esc_attr($title) . '"]');

  $chip_values = array_filter(array_map('trim', preg_split('/[,|]/', $topics . ',' . $categories)));
  $chip_values = array_slice(array_unique($chip_values), 0, 4);
  $lead_parts = [];
  if ($per > 0) {
    $lead_parts[] = sprintf(esc_html__('%d questions per level', 'hmquiz'), $per);
  }
  if ($levels > 1) {
    $lead_parts[] = sprintf(esc_html__('%d levels to clear', 'hmquiz'), $levels);
  }
  if ($difficulty) {
    $lead_parts[] = sprintf(esc_html__('Difficulty: %s', 'hmquiz'), $difficulty);
  }
  $hero_lead = $lead_parts ? implode(' • ', $lead_parts) : esc_html__('Short, fun quizzes. Answer, pass levels, see your score.', 'hmquiz');

  ob_start();
  ?>
  <div class="hmqz-play-shell">
    <div class="hmqz-play-hero">
      <div class="hmqz-play-inner">
        <header class="hmqz-play-header">
          <div class="hmqz-play-top">
            <div class="hmqz-play-brand">
              <?php if ($logo_url) : ?>
                <div class="hmqz-logo-wrap">
                  <img src="<?php echo esc_url($logo_url); ?>" alt="<?php esc_attr_e('HMQUIZ logo', 'hmquiz'); ?>" class="hmqz-logo">
                </div>
              <?php endif; ?>
              <div class="hmqz-brand-text">
                <div class="hmqz-brand-eyebrow"><?php esc_html_e('Short, fun quizzes', 'hmquiz'); ?></div>
                <div class="hmqz-brand-name">HMQUIZ</div>
              </div>
            </div>
            <div class="hmqz-topic-chip">
              <span class="hmqz-topic-label"><?php echo esc_html($topic_label); ?></span>
            </div>
          </div>

          <div class="hmqz-card-grid">
            <article class="hmqz-card hmqz-card-main">
              <div class="hmqz-card-head">
                <div class="hmqz-card-title-wrap">
                  <div class="hmqz-card-eyebrow"><?php esc_html_e('Live quiz', 'hmquiz'); ?></div>
                  <h1 class="hmqz-card-title"><?php echo esc_html($display_title); ?></h1>
                  <p class="hmqz-card-lead"><?php echo esc_html($hero_lead); ?></p>
                  <?php if ($chip_values) : ?>
                    <div class="hmqz-card-tags">
                      <?php foreach ($chip_values as $chip) : ?>
                        <span class="hmqz-chip"><?php echo esc_html($chip); ?></span>
                      <?php endforeach; ?>
                    </div>
                  <?php endif; ?>
                </div>
                <dl class="hmqz-card-meta-stack">
                  <div class="hmqz-card-meta">
                    <dt><?php esc_html_e('Level', 'hmquiz'); ?></dt>
                    <dd><?php echo esc_html(sprintf(__('Level %d/%d', 'hmquiz'), max(1, $level), max(1, $levels))); ?></dd>
                  </div>
                  <div class="hmqz-card-meta">
                    <dt><?php esc_html_e('Time', 'hmquiz'); ?></dt>
                    <dd><span class="hmqz-meta-pill hmqz-meta-pill-muted"><?php esc_html_e('Live', 'hmquiz'); ?></span></dd>
                  </div>
                  <div class="hmqz-card-meta">
                    <dt><?php esc_html_e('Progress', 'hmquiz'); ?></dt>
                    <dd><span class="hmqz-meta-pill hmqz-meta-pill-muted"><?php esc_html_e('Q ?/??', 'hmquiz'); ?></span></dd>
                  </div>
                </dl>
              </div>

              <div class="hmqz-card-body">
                <div class="hmqz-engine-slot">
                  <?php echo $inner; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped ?>
                </div>
              </div>

              <footer class="hmqz-card-footer">
                <p class="hmqz-footer-note"><?php esc_html_e('Tap your answer, move through the levels. Your score updates automatically.', 'hmquiz'); ?></p>
              </footer>
            </article>

            <aside class="hmqz-card hmqz-card-secondary">
              <h2 class="hmqz-secondary-title"><?php esc_html_e('How this quiz works', 'hmquiz'); ?></h2>
              <ol class="hmqz-steps">
                <li><?php esc_html_e('Answer each question by tapping the best option.', 'hmquiz'); ?></li>
                <li><?php esc_html_e('Clear the minimum number of correct answers to unlock the next level.', 'hmquiz'); ?></li>
                <li><?php esc_html_e('See your final score and level summary at the end.', 'hmquiz'); ?></li>
              </ol>
              <p class="hmqz-secondary-meta"><?php echo esc_html($hero_lead); ?></p>
            </aside>
          </div>
        </header>
      </div>
    </div>
  </div>
  <?php
  return ob_get_clean();
}

add_shortcode('hmqz_play', 'hmqz_render_play_shortcode');

